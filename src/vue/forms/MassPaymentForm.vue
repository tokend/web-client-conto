<template>
  <div class="mass-payment-form">
    <template v-if="isLoaded">
      <template v-if="isLoadFailed">
        <error-message
          :message="'mass-payment-form.error-msg' | globalize"
        />
      </template>

      <template v-else>
        <template v-if="transferableBalancesAssets.length">
          <form @submit.prevent="submit()">
            <div class="app__form-row">
              <div class="app__form-field">
                <p class="mass-payment-form__description">
                  <!-- eslint-disable-next-line max-len -->
                  {{ 'mass-payment-form.how-to-receivers-paragraph' | globalize }}
                </p>

                <textarea-field
                  name="mass-payment-receivers"
                  v-model="form.receivers"
                  :label="'mass-payment-form.receivers-lbl' | globalize"
                  :disabled="formMixin.isDisabled"
                  @blur="touchField('form.receivers')"
                  :error-message="getFieldErrorMessage('form.receivers')"
                  rows="8"
                />
              </div>
            </div>

            <div class="app__form-row">
              <div class="app__form-field">
                <select-field
                  name="mass-payment-asset-code"
                  v-model="form.assetCode"
                  :label="'mass-payment-form.asset-lbl' | globalize"
                  @blur="touchField('form.assetCode')"
                  :error-message="getFieldErrorMessage('form.assetCode')"
                  :disabled="formMixin.isDisabled"
                >
                  <option
                    v-for="asset in transferableBalancesAssets"
                    :key="asset.code"
                    :value="asset.code"
                  >
                    {{ asset.name }}
                  </option>
                </select-field>

                <template v-if="form.assetCode">
                  <p class="app__form-field-description">
                    {{
                      // eslint-disable-next-line max-len
                      'mass-payment-form.available-for-payment-hint' | globalize({
                        amount: {
                          value: accountBalance.balance,
                          currency: form.assetCode
                        }
                      })
                    }}
                  </p>
                </template>
              </div>
            </div>

            <div class="app__form-row">
              <div class="app__form-field">
                <amount-input-field
                  v-model="form.amount"
                  name="mass-payment-amount"
                  validation-type="outgoing"
                  :label="'mass-payment-form.amount-lbl' | globalize"
                  :asset="assetByCode(form.assetCode)"
                  :disabled="formMixin.isDisabled"
                />
              </div>
            </div>

            <div class="app__form-actions">
              <button
                v-ripple
                :disabled="formMixin.isDisabled"
                class="app__form-submit-btn app__button-raised"
                type="submit"
              >
                {{ 'mass-payment-form.submit-btn' | globalize }}
              </button>
            </div>
          </form>
        </template>

        <template v-else>
          <no-data-message
            class="mass-payment-form__no-data-message"
            icon-name="coins"
            :title="'mass-payment-form.no-assets-msg-title' | globalize"
            :message="'mass-payment-form.no-assets-msg-description' | globalize"
          />
        </template>
      </template>
    </template>

    <template v-else>
      <loader
        message-id="mass-payment-form.loading-msg"
      />
    </template>
  </div>
</template>

<script>
import FormMixin from '@/vue/mixins/form.mixin'
import IdentityGetterMixin from '@/vue/mixins/identity-getter'
import NoDataMessage from '@/vue/common/NoDataMessage'
import ErrorMessage from '@/vue/common/ErrorMessage'
import Loader from '@/vue/common/Loader'

import { required } from '@validators'

import { CsvUtil } from '@/js/utils/csv.util'
import { ErrorHandler } from '@/js/helpers/error-handler'
import { Bus } from '@/js/helpers/event-bus'

import { mapGetters, mapActions } from 'vuex'
import { vuexTypes } from '@/vuex'

import { api } from '@/api'
import { base } from '@tokend/js-sdk'
import { MathUtil } from '@/js/utils'

const EVENTS = {
  submitted: 'submitted',
}

export default {
  name: 'mass-payment-form',

  components: {
    NoDataMessage,
    ErrorMessage,
    Loader,
  },

  mixins: [FormMixin, IdentityGetterMixin],

  props: {
    receivers: {
      type: Array, /** {@link CustomerRecord} **/
      default: _ => [],
    },
    amount: { type: [String, Number], default: '' },
  },

  data () {
    return {
      form: {
        assetCode: '',
        receivers: '',
        amount: String(this.amount) || '',
      },
      isLoaded: false,
      isLoadFailed: false,
    }
  },

  validations () {
    return {
      form: {
        assetCode: {
          required,
        },
        receivers: {
          required,
        },
      },
    }
  },

  computed: {
    ...mapGetters([
      vuexTypes.transferableAssetsBalancesByOwner,
      vuexTypes.assetByCode,
      vuexTypes.accountBalanceByCode,
      vuexTypes.accountId,
    ]),

    accountBalance () {
      return this.accountBalanceByCode(this.form.assetCode)
    },
    transferableBalancesAssets () {
      return this.transferableAssetsBalancesByOwner(this.accountId)
        .filter(i => +i.balance > 0)
        .map(i => i.asset)
    },
  },

  async created () {
    this.form.receivers = this.receivers.map(i => i.email).join(', ')

    try {
      await this.loadAssets()
      await this.loadCurrentBalances()

      if (this.transferableBalancesAssets.length) {
        this.form.assetCode = this.transferableBalancesAssets[0].code
      }
    } catch (e) {
      this.isLoadFailed = true
      ErrorHandler.processWithoutFeedback(e)
    }
    this.isLoaded = true
  },

  methods: {
    ...mapActions({
      loadAssets: vuexTypes.LOAD_ASSETS,
      loadCurrentBalances: vuexTypes.LOAD_ACCOUNT_BALANCES_DETAILS,
    }),

    async submit () {
      if (!this.isFormValid()) return
      this.disableForm()

      try {
        const operations = await this.buildOperationsToSubmit()

        if (!operations.length) {
          Bus.error('mass-payment-form.no-receivers-found')
          this.enableForm()
          return
        }

        // Core cannot handle more than 100 operations per transaction
        if (operations.length >= 100) {
          Bus.error('mass-payment-form.too-much-op-error-notif')
          this.enableForm()
          return
        }

        const isOverpayment = MathUtil.compare(
          MathUtil.multiply(operations.length, this.form.amount),
          this.accountBalance.balance,
        ) > 0
        if (isOverpayment) {
          Bus.error('mass-payment-form.overpayment-error-notif')
          this.enableForm()
          return
        }

        await api.postOperations(...operations)

        await this.loadCurrentBalances()
        this.clearFieldsWithOverriding({
          receivers: this.form.receivers,
          assetCode: this.form.assetCode,
        })
        this.$emit(EVENTS.submitted)
        Bus.success('mass-payment-form.payment-successfully-notification')
        Bus.emit('customers:hideSelect')
      } catch (error) {
        ErrorHandler.process(error)
      }

      this.enableForm()
    },

    async getReceiverIdByEmail (email) {
      const receiver = this.receivers.find(i => i.email === email)
      if (receiver) {
        return receiver.accountId
      } else {
        return this.getAccountIdByIdentifier(email)
      }
    },

    async getOperationByEmail (email, proxyPaymentAccountId) {
      const receiverId = await this.getReceiverIdByEmail(email)
      if (receiverId) {
        return this.getOperation(receiverId, { subject: '' })
      } else {
        return this.getOperation(
          proxyPaymentAccountId,
          {
            subject: '',
            sender: this.accountId,
            email: email,
          }
        )
      }
    },

    async buildOperationsToSubmit () {
      const emails = CsvUtil.parseConcat(this.form.receivers, {
        trim: true,
        filterEmpty: true,
        delimiters: CsvUtil.delimiters.common,
      })

      const { data } = await api.get('/integrations/payment-proxy/info')
      return Promise.all(
        emails.map(email => this.getOperationByEmail(email, data.id))
      )
    },

    getOperation (destinationAccountId, subject) {
      return base
        .PaymentBuilder.payment({
          sourceBalanceId: this.accountBalance.id,
          destination: destinationAccountId,
          amount: String(this.form.amount),
          feeData: {
            sourceFee: {
              percent: '0',
              fixed: '0',
            },
            destinationFee: {
              percent: '0',
              fixed: '0',
            },
            sourcePaysForDest: false,
          },
          subject: JSON.stringify(subject),
          asset: this.form.assetCode,
        })
    },
  },
}
</script>

<style lang="scss" scoped>
@import './app-form';
@import '@/scss/variables';

p.mass-payment-form__description {
  line-height: 1.5;
  font-size: 1.6rem;
  margin-bottom: 2.4rem;
}
</style>
